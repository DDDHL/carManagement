"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/publicMethods.js"),o={data:()=>({carInfo:{},show:!1,title:"",content:"",type:"",popShow:!1,maintenance_km:0,km:0,license:"",date:"2023-4-15",index:0,array:["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],setType:"未设置提醒",startTime:""}),onLoad(){this.carInfo=this.$store.state.clickItem,console.log(this.carInfo),this.startTime=e.dayjs().format("YYYY-MM-DD"),this.flashData();let t=this.$store.state.loginInfo.info.carId.find((e=>e.id==this.carInfo._id));t?(this.date=e.dayjs(t.time).format("YYYY-MM-DD"),this.index=e.dayjs(t.time).format("HH"),this.setType="已设置定时提醒"):(this.date=e.dayjs().format("YYYY-MM-DD"),this.index=Number(e.dayjs().format("HH")))},methods:{bindDateChange(e){this.date=e.detail.value},bindTimeChange(e){this.index=e.detail.value},flashData(){this.maintenance_km=this.carInfo.maintenance_km,this.km=this.carInfo.km,this.license=this.carInfo.license},async save(){const t=e.Ls.database();if("update"===this.content){if(!this.km||!this.maintenance_km||!this.license)return void e.index.showToast({icon:"error",title:"请填写完整！",duration:2e3});e.index.showLoading({title:"执行中",mask:!0}),await t.collection("carInfo").where(`_id=="${this.carInfo._id}"`).update({maintenance_km:this.maintenance_km,km:this.km,license:this.license});for(let e=0;e<this.$store.state.loginInfo.info.carId.length;e++)if(this.$store.state.loginInfo.info.carId[e].id==this.carInfo._id){this.$store.state.loginInfo.info.carId[e].km=this.km,this.$store.state.loginInfo.info.carId[e].license=this.license;break}await t.collection("userInfo").where(`\n        openId=="${this.$store.state.loginInfo.info.openId}"`).update({carId:this.$store.state.loginInfo.info.carId}),e.index.hideLoading(),this.carInfo.maintenance_km=this.maintenance_km,this.carInfo.km=this.maintenance_km,this.carInfo.license=this.license,e.index.showToast({title:"更新成功",duration:1500}),this.popShow=!1}else{e.index.showLoading({title:"设置定时中",mask:!0});let o=this.date+" "+this.array[this.index],n=!1;for(let e=0;e<this.$store.state.loginInfo.info.carId.length;e++)if(this.$store.state.loginInfo.info.carId[e].id==this.carInfo._id){n=!0,this.$store.state.loginInfo.info.carId[e]={time:o,id:this.carInfo._id,openId:this.$store.state.loginInfo.info.openId,license:this.carInfo.license,km:this.carInfo.km,text:"定时提醒保养"};break}n||this.$store.state.loginInfo.info.carId.push({time:o,id:this.carInfo._id,openId:this.$store.state.loginInfo.info.openId,license:this.carInfo.license,km:this.carInfo.km,text:"车辆需要进行维修或者保养"}),0==(await t.collection("userInfo").where(`\nopenId=="${this.$store.state.loginInfo.info.openId}"`).update({carId:this.$store.state.loginInfo.info.carId})).result.errCode?(e.index.hideLoading(),e.index.showToast({title:"设置定时成功",duration:1500}),this.setType="已设置定时提醒"):(this.$store.state.loginInfo.info.carId.pop(),e.index.hideLoading(),e.index.showToast({title:"设置定时失败",duration:1500,icon:"error"}))}},toast(o){if(this.$store.state.loginInfo.isLogin)switch(this.type=o,o){case"set":e.index.requestSubscribeMessage({tmplIds:["yHEPvG95v7yLi2zFgWykNGhxNMLaeLEE8ku9px4RynY"]}).then((t=>{let o=!1;for(let e in t)"accept"==t[e]&&(o=!0),t["fail"==e]&&(o=!1);o?(this.title="设置定时提醒",this.content="set",this.popShow=!0):e.index.showModal({content:"请订阅消息并勾选不在提示！",showCancel:!1})}));break;case"delete":this.title="删除操作",this.content="确定要删除该车辆？",this.show=!0;break;case"update":this.title="编辑车辆信息",this.content="update",this.popShow=!0}else t.loginCheck()},confirm(){e.index.showLoading({title:"执行中",mask:!0}),this.deleteData(),this.show=!1},async deleteData(){const t=e.Ls.database();await t.collection("carInfo").where(`_id=="${this.carInfo._id}"`).remove(),await e.Ls.callFunction({name:"carManager",data:{type:"deleteImg",fileUrls:this.carInfo.imgUrls}});for(let e=0;e<this.$store.state.loginInfo.info.carId.length;e++)if(this.$store.state.loginInfo.info.carId[e].id==this.carInfo._id){this.$store.state.loginInfo.info.carId.splice(e,1);break}await t.collection("userInfo").where(`\n      openId=="${this.$store.state.loginInfo.info.openId}"`).update({carId:this.$store.state.loginInfo.info.carId}),e.index.hideLoading(),e.index.showToast({title:"删除成功",mask:!0,duration:1500}),setTimeout((()=>{e.index.switchTab({url:"/pages/index/index"})}),1500)}}};if(!Array){(e.resolveComponent("u-swiper")+e.resolveComponent("u-line")+e.resolveComponent("u-tag")+e.resolveComponent("u-button")+e.resolveComponent("u-modal")+e.resolveComponent("u--input")+e.resolveComponent("u-popup"))()}Math||((()=>"../../node-modules/uview-plus/components/u-swiper/u-swiper.js")+(()=>"../../node-modules/uview-plus/components/u-line/u-line.js")+(()=>"../../node-modules/uview-plus/components/u-tag/u-tag.js")+(()=>"../../node-modules/uview-plus/components/u-button/u-button.js")+(()=>"../../node-modules/uview-plus/components/u-modal/u-modal.js")+(()=>"../../node-modules/uview-plus/components/u--input/u--input.js")+(()=>"../../node-modules/uview-plus/components/u-popup/u-popup.js"))();const n=e._export_sfc(o,[["render",function(t,o,n,i,s,a){return e.e({a:e.p({list:s.carInfo.imgUrls,height:"300","img-mode":"aspectFill",indicator:!0,indicatorMode:"line",circular:!0}),b:e.p({text:"车牌号",size:"mini"}),c:e.t(s.carInfo.license),d:e.p({text:"公里数",size:"mini",type:"warning"}),e:e.t(s.carInfo.km),f:e.t(s.carInfo.maintenance_km),g:e.o((e=>a.toast("delete"))),h:e.p({type:"error",text:"删除车辆"}),i:e.o((e=>a.toast("set"))),j:e.p({type:"warning",text:"设置提醒"}),k:e.o((e=>a.toast("update"))),l:e.p({type:"success",text:"编辑信息"}),m:e.o((e=>s.show=!1)),n:e.o(a.confirm),o:e.p({show:s.show,showCancelButton:!0,buttonReverse:!0,title:s.title,content:s.content}),p:e.t(s.title),q:"update"===s.content},"update"===s.content?{r:e.o((e=>s.license=e)),s:e.p({placeholder:"请输入车牌号",border:"surround",modelValue:s.license}),t:e.o((e=>s.km=e)),v:e.p({placeholder:"请输入公里数",type:"number",border:"surround",modelValue:s.km}),w:e.o((e=>s.maintenance_km=e)),x:e.p({placeholder:"请输入保养公里数",type:"number",border:"surround",modelValue:s.maintenance_km})}:{y:e.t(s.date),z:s.date,A:s.startTime,B:e.o(((...e)=>a.bindDateChange&&a.bindDateChange(...e))),C:e.t(s.array[s.index]),D:e.o(((...e)=>a.bindTimeChange&&a.bindTimeChange(...e))),E:s.index,F:s.array,G:e.t(s.setType),H:e.s("未设置提醒"===s.setType?"color:red;":"color:green;")},{I:e.o(a.save),J:e.p({type:"success",text:"保存设置"}),K:e.o((e=>s.popShow=!1)),L:e.p({show:s.popShow,mode:"bottom",round:"20"})})}],["__scopeId","data-v-d184d62b"]]);wx.createPage(n);
